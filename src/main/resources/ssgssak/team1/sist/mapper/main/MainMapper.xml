<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="ssgssak.team1.sist.mapper.main.MainMapper">
	<!-- <delete id="delete"> DELETE FROM tbl_board WHERE bno=#{bno} </delete> -->

<select id="getProList" resultType="MainProductListDTO">
<<<<<<< HEAD
      SELECT *
      FROM (
      SELECT ROWNUM no, t.*
      FROM (
      SELECT
      p.ID,
      MAX(p.SHIPPINGOPTIONID) AS SHIPPINGOPTIONID,
      MAX(p.sellerstoreid) AS   SELLERSTOREID,
      MAX(s.SELLERNAME) AS SELLERNAME,
      MAX(p.brandid) AS BRANDID,
      MAX(b.brandname) AS BRANDNAME,
      MAX(p.PDNAME) AS PDNAME,
      MAX(p.UPDATEDAY) AS UPDATEDAY,
      COALESCE(MAX(o.optionPrice), 0) AS optionPrice,
      COALESCE(MAX(o.optionPrice) - ((MAX(o.optionPrice) / 100) * MAX(c.spclDscnRt)), 0) AS sprice,
      COALESCE(MAX(c.spclDscnRt), 0) AS discount,
      COALESCE(MAX(reviewData.reviewCount), 0) AS reviewCount,
      COALESCE(MAX(reviewData.avgGrade), 0) AS avgGrade,
      MAX(productimg.IMGURL) AS imgurl
      FROM
      PRODUCT p
      JOIN BRAND b ON p.BRANDID = b.ID
      JOIN sellerstore s ON p.SELLERSTOREID = s.id
      LEFT JOIN productOption o ON p.ID = o.productid
      LEFT JOIN specialprice c ON p.specialPriceId = c.id
      LEFT JOIN (
      SELECT productId,
      COUNT(*) AS reviewCount, 
      AVG(grade) AS avgGrade
      FROM review
      GROUP BY productId
      ) reviewData ON p.ID = reviewData.productId
      LEFT JOIN (
        SELECT DISTINCT productid, IMGURL
        FROM productimg
        WHERE IMGCONTENT = 'sum' OR IMGCONTENT LIKE 'SUM'
        ) productimg ON p.id = productimg.productid
      WHERE TO_CHAR(p.CATEGORYID) LIKE #{catename} || '%'
      GROUP BY p.id

      ) t

      ) b
      WHERE no BETWEEN 1 AND 4
=======
SELECT *
FROM
(
with temp as (
    SELECT  pt.id pd, sp.spcldscnrt cnrt,sp.spclnm spcl, pt.categoryid, pt.brandid, sp.spcldscnrt dscnrt
    FROM product pt LEFT JOIN specialprice sp ON pt.specialpriceid = sp.id
 )
 SELECT DISTINCT tp.pd id, pd.pdname name, pd.pcontent content, pi.imgurl url, rv.grade grade , ROW_NUMBER() OVER (PARTITION BY po.productid ORDER BY po.optionprice) as row_num , po.optionprice price ,tp.spcl spcl, (po.optionprice * (100 - tp.cnrt) / 100) disprice,  po.optionprice * (tp.cnrt / 100) cnrt, cg.id cateid, bd.brandname brandname, tp.dscnrt dscnrt
FROM temp tp    LEFT JOIN product pd ON tp.pd = pd.id 
              LEFT JOIN productoption po ON tp.pd = po.productid 
                LEFT JOIN productimg pi ON tp.pd = pi.productid 
		               LEFT JOIN review rv ON tp.pd = rv.productid 
                       LEFT JOIN category cg ON tp.categoryid = cg.id
                       LEFT JOIN brand bd ON tp.brandid = bd.id
WHERE cg.id IN ( SELECT id
                FROM category 
                WHERE majorcatename = #{catename})
                       
 order by tp.pd  
				 ) b 
				 WHERE row_num = 1 
>>>>>>> d7f92b04ccb061e8589ca987559b69b0d671fe38
</select>

</mapper>